name: App Store

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to submit (e.g., 1.2.3)'
        required: true
        type: string

permissions:
  contents: read

env:
  PROJECT: TinyClips.xcodeproj
  SCHEME: TinyClipsMAS
  PRODUCT_NAME: TinyClipsMAS

jobs:
  build-and-upload:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-mas-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-mas-

      - name: Resolve Swift packages
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }}

      - name: Install signing certificates
        env:
          APP_DIST_CERT_BASE64: ${{ secrets.MAS_APP_DIST_CERT_BASE64 }}
          APP_DIST_CERT_PASSWORD: ${{ secrets.MAS_APP_DIST_CERT_PASSWORD }}
          INSTALLER_CERT_BASE64: ${{ secrets.MAS_INSTALLER_CERT_BASE64 }}
          INSTALLER_CERT_PASSWORD: ${{ secrets.MAS_INSTALLER_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.MAS_KEYCHAIN_PASSWORD }}
        run: |
          APP_CERT_PATH="$RUNNER_TEMP/mas_app_dist.p12"
          INSTALLER_CERT_PATH="$RUNNER_TEMP/mas_installer_dist.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/mas-signing.keychain-db"

          echo -n "$APP_DIST_CERT_BASE64" | base64 --decode -o "$APP_CERT_PATH"
          echo -n "$INSTALLER_CERT_BASE64" | base64 --decode -o "$INSTALLER_CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$APP_CERT_PATH" -P "$APP_DIST_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security import "$INSTALLER_CERT_PATH" -P "$INSTALLER_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain

          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Install provisioning profile
        env:
          MAS_PROVISIONING_PROFILE_BASE64: ${{ secrets.MAS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_PATH="$RUNNER_TEMP/mas.provisionprofile"
          echo -n "$MAS_PROVISIONING_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i "$PROFILE_PATH")")
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.provisionprofile"
          echo "Installed provisioning profile UUID: $UUID"

      - name: Create App Store Connect API key
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
          APPSTORE_API_PRIVATE_KEY_BASE64: ${{ secrets.APPSTORE_API_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p "$RUNNER_TEMP/private_keys"
          echo -n "$APPSTORE_API_PRIVATE_KEY_BASE64" | base64 --decode -o "$RUNNER_TEMP/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8"
          echo "APPSTORE_API_KEY_PATH=$RUNNER_TEMP/private_keys/AuthKey_${APPSTORE_API_KEY_ID}.p8" >> "$GITHUB_ENV"

      - name: Set version and build numbers
        run: |
          VERSION="${{ github.event.inputs.version }}"
          BUILD_NUMBER="${{ github.run_number }}"

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" TinyClips/Info-MAS.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" TinyClips/Info-MAS.plist

          echo "MARKETING_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> "$GITHUB_ENV"

      - name: Archive (MAS)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MAS_PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.MAS_PROVISIONING_PROFILE_SPECIFIER }}
        run: |
          xcodebuild archive \
            -project ${{ env.PROJECT }} \
            -scheme ${{ env.SCHEME }} \
            -configuration Release \
            -archivePath "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}.xcarchive" \
            -allowProvisioningUpdates \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$MAS_PROVISIONING_PROFILE_SPECIFIER" \
            MARKETING_VERSION="${{ env.MARKETING_VERSION }}" \
            CURRENT_PROJECT_VERSION="${{ env.BUILD_NUMBER }}"

      - name: Export archive for App Store
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat > "$RUNNER_TEMP/ExportOptions.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>$APPLE_TEAM_ID</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/${{ env.PRODUCT_NAME }}.xcarchive" \
            -exportPath "$RUNNER_TEMP/Export" \
            -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
            -allowProvisioningUpdates

          ls -la "$RUNNER_TEMP/Export"

      - name: Upload to App Store Connect
        env:
          APPSTORE_API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APPSTORE_API_ISSUER_ID: ${{ secrets.APPSTORE_API_ISSUER_ID }}
        run: |
          PKG_PATH=$(find "$RUNNER_TEMP/Export" -name "*.pkg" -print -quit)
          if [ -z "$PKG_PATH" ]; then
            echo "No .pkg found in export output"
            exit 1
          fi

          xcrun altool --upload-app \
            --type macos \
            --file "$PKG_PATH" \
            --apiKey "$APPSTORE_API_KEY_ID" \
            --apiIssuer "$APPSTORE_API_ISSUER_ID"

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/mas-signing.keychain-db" || true
